<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=900, initial-scale=1.0">
  <title>미생물 닮은꼴 찾기</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>
  <style>
    body {box-sizing:border-box;font-family:'Noto Sans KR',sans-serif;margin:0;padding:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333;}
    .container {max-width:900px;margin:0 auto;padding:20px;text-align:center;}
    .start-screen, .main-screen {background:rgba(255,255,255,.95);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);margin:20px;}
    .start-screen {display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80vh;padding:40px;}
    .main-title {font-size:2.5rem;font-weight:700;color:#4c1d95;margin-bottom:20px;text-shadow:2px 2px 4px rgba(0,0,0,.1);}
    .subtitle {font-size:1.2rem;color:#6b7280;margin-bottom:40px;line-height:1.6;}
    .microorganism-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:20px;margin:30px 0;max-width:600px;}
    .microorganism-card {background:white;border-radius:15px;padding:20px;box-shadow:0 8px 16px rgba(0,0,0,.1);transition:.3s;}
    .microorganism-card:hover {transform:translateY(-5px);}
    .microorganism-icon {width:48px;height:48px;object-fit:cover;vertical-align:middle;margin-bottom:10px;border-radius:10px;}
    .microorganism-name {font-size:.9rem;font-weight:600;color:#4c1d95;}
    .main-screen {display:none;padding:30px;}
    .camera-select {margin-bottom:18px;display:flex;justify-content:center;align-items:center;gap:10px;}
    .camera-select label{font-size:1.05em;color:#4c1d95;font-weight:600;margin-right:4px;}
    .camera-select select{padding:10px 18px;font-size:1em;border-radius:10px;border:1px solid #c7d2fe;background:#f3f4f6;color:#312e81;min-width:110px;margin-right:2px;}
    .camera-select .btn{margin:0 0 0 4px;padding:8px 22px;font-size:.95em;border-radius:20px;}
    .camera-container{position:relative;display:inline-block;margin-bottom:30px;}
    #webcam,#canvas{width:100%;max-width:500px;height:auto;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.2);background:#f3f4f6;}
    #canvas{display:none;}
    .controls{display:flex;flex-wrap:wrap;justify-content:center;gap:15px;margin-bottom:30px;}
    .btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:12px 24px;border-radius:25px;font-size:1rem;font-weight:600;cursor:pointer;transition:.3s;box-shadow:0 4px 15px rgba(102,126,234,.4);}
    .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.6);}
    .btn:active{transform:translateY(0);}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}
    .btn-secondary{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);box-shadow:0 4px 15px rgba(245,158,11,.4);}
    .btn-secondary:hover{box-shadow:0 6px 20px rgba(245,158,11,.6);}
    .file-input{display:none;}
    .result-container{background:white;border-radius:15px;padding:25px;margin-top:20px;box-shadow:0 8px 16px rgba(0,0,0,.1);display:none;}
    .result-title{font-size:1.5rem;font-weight:700;color:#4c1d95;margin-bottom:15px;}
    .result-microorganism{font-size:2rem;margin:20px 0;}
    .result-description{font-size:1.1rem;color:#6b7280;line-height:1.6;margin-bottom:20px;}
    .confidence-bar{background:#e5e7eb;border-radius:10px;height:20px;margin:10px 0;overflow:hidden;}
    .confidence-fill{background:linear-gradient(90deg,#10b981,#059669);height:100%;border-radius:10px;transition:.5s;}
    .confidence-text{font-size:.9rem;color:#6b7280;margin-top:5px;}
    .loading{display:none;flex-direction:column;align-items:center;margin:20px 0;}
    .spinner{width:40px;height:40px;border:4px solid #e5e7eb;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:10px;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    @media(max-width:768px){.main-title{font-size:2rem;}.container{padding:10px;}.start-screen,.main-screen{margin:10px;padding:20px;}.controls{flex-direction:column;align-items:center;}.btn{width:200px;}}
  </style>
</head>
<body>
<main class="container">
  <div id="startScreen" class="start-screen">
    <h1 class="main-title">지금부터 미생물 닮은꼴 찾기를 시작해볼까요?</h1>
    <p class="subtitle">AI가 당신의 얼굴을 분석하여 가장 닮은 미생물을 찾아드립니다!</p>
    <div class="microorganism-grid">
      <div class="microorganism-card">
        <img src="img/아메바_icon.png" class="microorganism-icon" alt="아메바">
        <div class="microorganism-name">아메바</div>
      </div>
      <div class="microorganism-card">
        <img src="img/유글레나_icon.png" class="microorganism-icon" alt="유글레나">
        <div class="microorganism-name">유글레나</div>
      </div>
      <div class="microorganism-card">
        <img src="img/짚신벌레_icon.png" class="microorganism-icon" alt="짚신벌레">
        <div class="microorganism-name">짚신벌레</div>
      </div>
      <div class="microorganism-card">
        <img src="img/콜피디움_icon.png" class="microorganism-icon" alt="콜피디움">
        <div class="microorganism-name">콜피디움</div>
      </div>
    </div>
    <button id="startBtn" class="btn">닮은꼴 찾으러 가기</button>
  </div>
  <div id="mainScreen" class="main-screen">
    <h2 class="result-title">카메라로 사진을 찍거나 파일을 업로드하세요</h2>
    <div class="camera-select">
      <label id="cameraSelectLabel" style="display:none">카메라 선택</label>
      <select id="cameraSelect" style="display:none"></select>
      <button id="switchCameraBtn" class="btn btn-secondary">카메라 전환</button>
    </div>
    <div class="camera-container">
      <video id="webcam" autoplay muted playsinline></video>
      <canvas id="canvas"></canvas>
    </div>
    <div class="controls">
      <button id="captureBtn" class="btn">사진 찍기</button>
      <label for="fileInput" id="uploadLabel" class="btn btn-secondary">사진 업로드</label>
      <input type="file" id="fileInput" class="file-input" accept="image/*">
      <button id="analyzeBtn" class="btn" style="display:none;">검사하기</button>
      <button id="retryBtn" class="btn btn-secondary" style="display:none;">다시 하기</button>
    </div>
    <div class="loading" id="loading"><div class="spinner"></div><p>AI가 분석 중입니다...</p></div>
    <div id="resultContainer" class="result-container">
      <h3 class="result-title">분석 결과</h3>
      <div id="resultMicroorganism" class="result-microorganism"></div>
      <div id="resultDescription" class="result-description"></div>
      <div class="confidence-bar"><div id="confidenceFill" class="confidence-fill"></div></div>
      <div id="confidenceText" class="confidence-text"></div>
      <button id="saveResultBtn" class="btn" style="margin-top:24px;">분석 결과 저장하기</button>
    </div>
  </div>
</main>
<script>
const microorganisms={
  "아메바":     { name:"아메바",     iconImg:"img/아메바_icon.png",     description:"아메바는 몸의 형태를 자유롭게 바꾸며 유사위족으로 이동하는 단세포 생물입니다." },
  "유글레나":   { name:"유글레나",   iconImg:"img/유글레나_icon.png",   description:"유글레나는 엽록체를 가진 편모 생물로, 광합성과 운동이 모두 가능한 원생생물입니다." },
  "짚신벌레":   { name:"짚신벌레",   iconImg:"img/짚신벌레_icon.png",   description:"짚신벌레는 섬모로 이동하며, 담수에서 자주 발견되는 대표적인 원생동물입니다." },
  "콜피디움":   { name:"콜피디움",   iconImg:"img/콜피디움_icon.png",   description:"콜피디움은 짧은 섬모로 이동하는 미세한 단세포 생물로, 실험에서 관찰하기 쉽습니다." }
};
let model,webcamStream,usingUpload=false,capturedImage=null,deviceInfos=[],currentDeviceId=null;
const $=id=>document.getElementById(id);
const show=(el,on=true)=>el.style.display=on?'block':'none';
const getCameras=async()=>{
  const devices=await navigator.mediaDevices.enumerateDevices();
  deviceInfos=devices.filter(d=>d.kind==="videoinput");
  $("cameraSelect").innerHTML='';
  deviceInfos.forEach((d,i)=>{
    let label=d.label||(i==0?"기본 카메라":`카메라 ${i+1}`);
    if(d.label.toLowerCase().includes('front'))label="전면 카메라";
    else if(d.label.toLowerCase().includes('back'))label="후면 카메라";
    let o=document.createElement('option');o.value=d.deviceId;o.text=label;
    $("cameraSelect").appendChild(o);
  });
  let showCam=deviceInfos.length>1;
  show($("cameraSelect"),showCam);show($("cameraSelectLabel"),showCam);
};
const startCamera=async(deviceId=null)=>{
  if(webcamStream)webcamStream.getTracks().forEach(track=>track.stop());
  let c={video:{width:{ideal:640},height:{ideal:480}}};
  if(deviceId)c.video.deviceId={exact:deviceId};
  try{
    webcamStream=await navigator.mediaDevices.getUserMedia(c);
    $("webcam").srcObject=webcamStream;show($("webcam"));
    currentDeviceId=deviceId;
  }catch(e){
    alert('카메라에 접근할 수 없습니다.');$("captureBtn").style.display='none';
  }
};
const loadModel=async()=>model||(model=await window.tmImage.load(
  "https://teachablemachine.withgoogle.com/models/N2Lw4iMw4/model.json",
  "https://teachablemachine.withgoogle.com/models/N2Lw4iMw4/metadata.json"
));
$("startBtn").onclick=async()=>{
  show($("startScreen"),false);show($("mainScreen"));
  await getCameras();
  $("cameraSelect").value=deviceInfos[0]?deviceInfos[0].deviceId:null;
  await startCamera($("cameraSelect").value);
  show($("canvas"),false);show($("captureBtn"));show($("uploadLabel"));
  show($("analyzeBtn"),false);show($("retryBtn"),false);show($("resultContainer"),false);
};
$("switchCameraBtn").onclick=async()=>{
  await getCameras();
  let showCam=deviceInfos.length>1;
  show($("cameraSelect"),showCam);show($("cameraSelectLabel"),showCam);$("cameraSelect").focus();
};
$("cameraSelect").onchange=async()=>{await startCamera($("cameraSelect").value);show($("webcam"));show($("canvas"),false);show($("captureBtn"));show($("uploadLabel"));show($("analyzeBtn"),false);show($("retryBtn"),false);show($("resultContainer"),false);};
$("captureBtn").onclick=()=>{
  usingUpload=false;
  $("canvas").width=640;$("canvas").height=480;
  // 중앙 crop, 비율 유지(세로든 가로든 상관없이 꽉차게)
  const ctx=$("canvas").getContext('2d');
  const video=$("webcam");
  const videoW=video.videoWidth,videoH=video.videoHeight;
  let sx=0,sy=0,sw=videoW,sh=videoH;
  const targetW=640,targetH=480,targetRatio=targetW/targetH,videoRatio=videoW/videoH;
  if(videoRatio>targetRatio){sw=videoH*targetRatio;sx=(videoW-sw)/2;}else{sh=videoW/targetRatio;sy=(videoH-sh)/2;}
  ctx.drawImage(video,sx,sy,sw,sh,0,0,targetW,targetH);
  show($("webcam"),false);show($("canvas"));show($("captureBtn"),false);show($("uploadLabel"),false);show($("analyzeBtn"));show($("retryBtn"));show($("resultContainer"),false);
  $("canvas").toBlob(blob=>capturedImage=blob);
};
$("fileInput").onchange=e=>{
  usingUpload=true;
  const file=e.target.files[0];if(!file)return;
  const img=new Image();
  img.onload=()=>{
    $("canvas").width=640;$("canvas").height=480;
    let ctx=$("canvas").getContext('2d');
    // 중앙 crop, 비율 유지
    const imgW=img.width,imgH=img.height;
    let sx=0,sy=0,sw=imgW,sh=imgH;
    const targetW=640,targetH=480,targetRatio=targetW/targetH,imgRatio=imgW/imgH;
    if(imgRatio>targetRatio){sw=imgH*targetRatio;sx=(imgW-sw)/2;}else{sh=imgW/targetRatio;sy=(imgH-sh)/2;}
    ctx.drawImage(img,sx,sy,sw,sh,0,0,targetW,targetH);
    show($("webcam"),false);show($("canvas"));show($("captureBtn"),false);show($("uploadLabel"),false);show($("analyzeBtn"));show($("retryBtn"));show($("resultContainer"),false);
    $("canvas").toBlob(blob=>capturedImage=blob);
  };
  img.onerror=()=>alert('이미지 로드 오류가 발생했습니다.');
  img.src=URL.createObjectURL(file);
};
$("analyzeBtn").onclick=async()=>{
  if(!capturedImage){alert('먼저 사진을 촬영하거나 업로드해주세요.');return;}
  show($("loading"),true);$("analyzeBtn").disabled=true;await loadModel();
  let predictions=await model.predict($("canvas"));
  if(!predictions||predictions.length==0){alert("예측 결과 없음");show($("loading"),false);$("analyzeBtn").disabled=false;return;}
  predictions.sort((a,b)=>b.probability-a.probability);
  let top=predictions[0],key=top.className,confidence=Math.round(top.probability*100);
  const org=microorganisms[key];
  $("resultMicroorganism").innerHTML=org
    ? `<img src="${org.iconImg}" alt="${org.name}" style="width:48px;height:48px;vertical-align:middle;border-radius:10px;margin-right:8px;"> <strong>${org.name}</strong>`
    : key;
  $("resultDescription").textContent=org?org.description:'';
  $("confidenceFill").style.width=`${confidence}%`;
  $("confidenceText").textContent=`신뢰도: ${confidence}%`;
  show($("resultContainer"));show($("loading"),false);$("analyzeBtn").disabled=false;
};
$("retryBtn").onclick=()=>{
  show($("webcam"),webcamStream&&!usingUpload);show($("canvas"),false);
  show($("captureBtn"),webcamStream?true:false);show($("uploadLabel"));show($("analyzeBtn"),false);show($("retryBtn"),false);show($("resultContainer"),false);
  capturedImage=null;if(usingUpload){$("fileInput").value="";usingUpload=false;}
};
window.addEventListener('beforeunload', ()=>{
  if(webcamStream) webcamStream.getTracks().forEach(track=>track.stop());
});

// 저장: 미리보기(분석) 사진 + 대표 미생물 이미지를 카드 전체에 세로로 겹침
$("saveResultBtn").onclick=()=>{
  const cardW=1181, cardH=1772, cardCanvas=document.createElement('canvas');
  cardCanvas.width=cardW; cardCanvas.height=cardH;
  const ctx=cardCanvas.getContext('2d');
  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,cardW,cardH);

  // 1. 미리보기(분석) 사진(카드 상단 일부)
  const img2 = new Image();
  img2.src = document.getElementById('canvas').toDataURL('image/png');
  img2.onload = function(){
    let imgH = Math.round(cardH*0.45);
    let imgW = Math.round(img2.width * (imgH / img2.height));
    if(imgW > cardW-80){
      imgW = cardW-80;
      imgH = Math.round(img2.height * (imgW / img2.width));
    }
    const imgX = Math.round((cardW-imgW)/2);
    const imgY = 60;
    ctx.drawImage(img2, imgX, imgY, imgW, imgH);

    // 2. 대표 미생물 이미지를 카드 전체 세로에 꽉차게(중앙정렬)
    let orgName = document.getElementById('resultMicroorganism').textContent.replace(/[^가-힣]/g,"")||"";
    let imgUrl = orgName ? "img/"+orgName+".jpg" : null;
    if(imgUrl){
      let repImg = new Image();
      repImg.crossOrigin="anonymous";
      repImg.onload = function(){
        let repH = cardH;
        let repW = repImg.width * (repH / repImg.height);
        let repX = Math.round((cardW - repW) / 2), repY = 0;
        ctx.drawImage(repImg, repX, repY, repW, repH);
        saveCard();
      };
      repImg.onerror = function(){ saveCard(); };
      repImg.src = imgUrl;
    } else {
      saveCard();
    }

    function saveCard(){
      cardCanvas.toBlob(function(blob){
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);a.download='analysis_card.png';a.click();URL.revokeObjectURL(a.href);
      },'image/png');
    }
  }
};
</script>
</body>
</html>
